<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booking - Booking System</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-light border-bottom">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Booking System</a>

      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-outline-secondary" href="dashboard.html">My Bookings</a>
        <button class="btn btn-outline-danger" type="button" onclick="logout()">
          Logout
        </button>
      </div>
    </div>
  </nav>

  <div class="container py-5" style="max-width: 720px;">
    <div class="card shadow-sm rounded-4">
      <div class="card-body p-4">
        <h3 class="fw-bold mb-3">Book an Appointment</h3>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input id="date" type="date" class="form-control" />
            <div class="form-text">Weekends are not allowed.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Time</label>
            <input id="time" type="time" class="form-control" min="09:00" max="17:00" />
            <div class="form-text">Working hours: 09:00 - 17:00</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Service</label>
            <select id="service" class="form-select">
              <option value="">Select service</option>
              <option value="Consultation">Consultation</option>
              <option value="Support">Support</option>
              <option value="Follow-up">Follow-up</option>
            </select>
          </div>
        </div>

        <button
          id="bookBtn"
          class="btn btn-warning mt-4 w-100"
          type="button"
          onclick="book()"
        >
          <span id="bookBtnText">Confirm Booking</span>
          <span
            id="bookSpinner"
            class="spinner-border spinner-border-sm ms-2 d-none"
            role="status"
            aria-hidden="true"
          ></span>
        </button>

        <div id="msg" class="mt-3 mb-0"></div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Auth protection -->
  <script src="auth.js"></script>
  <script>
    requireLogin();
  </script>

  <script>
    // ✅ Render backend URL (Online)
    const API_BASE = "https://web-tech-5s0d.onrender.com";

    // Optional: if admin opens this page, redirect to admin dashboard
    (function redirectAdmin() {
      const role = (localStorage.getItem("role") || "user").toLowerCase();
      if (role === "admin") {
        window.location.href = "admin.html";
      }
    })();

    function logout() {
      localStorage.removeItem("userId");
      localStorage.removeItem("role");
      window.location.href = "index.html";
    }

    function setMessage(type, text) {
      const msg = document.getElementById("msg");
      msg.innerHTML = `<div class="alert alert-${type} mb-0">${text}</div>`;
    }

    function setLoading(isLoading) {
      const btn = document.getElementById("bookBtn");
      const spinner = document.getElementById("bookSpinner");
      btn.disabled = isLoading;
      spinner.classList.toggle("d-none", !isLoading);
    }

    // ✅ Prevent past dates
    (function setMinDate() {
      const dateInput = document.getElementById("date");
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.min = `${yyyy}-${mm}-${dd}`;
    })();

    // ✅ Weekend check
    function isWeekend(dateStr) {
      const d = new Date(dateStr + "T00:00:00");
      const day = d.getDay(); // 0=Sun, 6=Sat
      return day === 0 || day === 6;
    }

    // When user selects a date, block weekends
    document.getElementById("date").addEventListener("change", () => {
      const dateVal = document.getElementById("date").value;
      if (!dateVal) return;

      if (isWeekend(dateVal)) {
        document.getElementById("date").value = "";
        setMessage("danger", "No bookings on weekends (Saturday/Sunday). Please choose a weekday.");
      } else {
        document.getElementById("msg").innerHTML = "";
      }
    });

    // ✅ Validate time within working hours
    function timeToMinutes(t) {
      const [h, m] = t.split(":").map(Number);
      return h * 60 + m;
    }

    function isWithinWorkingHours(timeStr) {
      const minutes = timeToMinutes(timeStr);
      const start = 9 * 60;   // 09:00
      const end = 17 * 60;    // 17:00
      return minutes >= start && minutes <= end;
    }

    async function book() {
      const userId = localStorage.getItem("userId");
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const service = document.getElementById("service").value;

      document.getElementById("msg").innerHTML = "";

      if (!date || !time || !service) {
        setMessage("danger", "Please fill all fields.");
        return;
      }

      if (isWeekend(date)) {
        setMessage("danger", "No bookings on weekends (Saturday/Sunday). Please choose a weekday.");
        return;
      }

      if (!isWithinWorkingHours(time)) {
        setMessage("danger", "Working hours are 09:00 to 17:00.");
        return;
      }

      setLoading(true);

      try {
        const res = await fetch(`${API_BASE}/api/book`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId, date, time, service })
        });

        const data = await res.json();
        const ok = (data.message || "").includes("✅");

        setMessage(ok ? "success" : "danger", data.message || "Done");

        if (ok) {
          document.getElementById("date").value = "";
          document.getElementById("time").value = "";
          document.getElementById("service").value = "";
        }
      } catch (err) {
        setMessage("danger", "Failed to connect to server. Please try again.");
        console.log(err);
      } finally {
        setLoading(false);
      }
    }
  </script>
</body>
</html>
