<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - Booking System</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-light border-bottom">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Booking System</a>

      <div class="ms-auto d-flex gap-2">
        <button class="btn btn-outline-secondary" type="button" onclick="loadAllBookings()">
          Refresh
        </button>
        <button class="btn btn-outline-danger" type="button" onclick="logout()">
          Logout
        </button>
      </div>
    </div>
  </nav>

  <div class="container py-5" style="max-width: 1100px;">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
      <div>
        <h2 class="fw-bold mb-1">Admin Dashboard</h2>
        <div class="text-muted">Search, filter, and manage all bookings.</div>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <input
          id="search"
          class="form-control"
          style="min-width: 260px;"
          placeholder="Search name / email / service"
        />
        <input
          id="filterDate"
          type="date"
          class="form-control"
          style="max-width: 190px;"
        />
        <button class="btn btn-primary" type="button" onclick="applyFilters()">Apply</button>
        <button class="btn btn-outline-secondary" type="button" onclick="clearFilters()">Clear</button>
      </div>
    </div>

    <div id="status" class="alert alert-info">Loading all bookings...</div>

    <div class="card shadow-sm rounded-4">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped m-0 align-middle">
            <thead>
              <tr>
                <th style="min-width: 160px;">User</th>
                <th style="min-width: 220px;">Email</th>
                <th style="min-width: 130px;">Date</th>
                <th style="min-width: 110px;">Time</th>
                <th style="min-width: 160px;">Service</th>
                <th style="min-width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirm Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this booking?
          <div class="text-muted mt-2" id="deleteInfo"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            <span id="delBtnText">Delete</span>
            <span
              id="delSpinner"
              class="spinner-border spinner-border-sm ms-2 d-none"
              role="status"
              aria-hidden="true"
            ></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Auth -->
  <script src="auth.js"></script>

  <script>
    // ✅ IMPORTANT:
    // If another device wants to connect, change localhost to YOUR PC IP
    // Example: const API_BASE = "http://192.168.1.50:3000";
    const API_BASE = "http://localhost:3000";

    requireAdmin();

    let pendingDeleteId = null;
    let deleteModal = null;

    function logout() {
      localStorage.removeItem("userId");
      localStorage.removeItem("role");
      window.location.href = "index.html";
    }

    function setStatus(type, text) {
      const status = document.getElementById("status");
      status.className = `alert alert-${type}`;
      status.innerText = text;
    }

    function applyFilters() {
      loadAllBookings();
    }

    function clearFilters() {
      document.getElementById("search").value = "";
      document.getElementById("filterDate").value = "";
      loadAllBookings();
    }

    // Press Enter to search
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const active = document.activeElement?.id;
        if (active === "search" || active === "filterDate") loadAllBookings();
      }
    });

    function openDeleteModal(bookingId, infoText) {
      pendingDeleteId = bookingId;
      document.getElementById("deleteInfo").innerText = infoText || "";

      if (!deleteModal) {
        deleteModal = new bootstrap.Modal(document.getElementById("deleteModal"));
      }
      deleteModal.show();
    }

    function setDeleteLoading(isLoading) {
      const btn = document.getElementById("confirmDeleteBtn");
      const sp = document.getElementById("delSpinner");
      btn.disabled = isLoading;
      sp.classList.toggle("d-none", !isLoading);
    }

    async function confirmDelete() {
      const adminId = localStorage.getItem("userId");
      if (!pendingDeleteId) return;

      setDeleteLoading(true);

      try {
        const res = await fetch(
          `${API_BASE}/api/admin/booking/${encodeURIComponent(pendingDeleteId)}?adminId=${encodeURIComponent(adminId)}`,
          { method: "DELETE" }
        );

        const data = await res.json();

        if ((data.message || "").includes("✅")) {
          setStatus("success", data.message);
          if (deleteModal) deleteModal.hide();
          pendingDeleteId = null;
          loadAllBookings();
        } else {
          setStatus("danger", data.message || "Failed to delete booking.");
        }
      } catch (err) {
        setStatus("danger", "Failed to delete. Make sure backend is running.");
        console.log(err);
      } finally {
        setDeleteLoading(false);
      }
    }

    document.getElementById("confirmDeleteBtn").addEventListener("click", confirmDelete);

    async function loadAllBookings() {
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";
      setStatus("info", "Loading all bookings...");

      const adminId = localStorage.getItem("userId");
      const q = (document.getElementById("search").value || "").trim();
      const date = (document.getElementById("filterDate").value || "").trim();

      const params = new URLSearchParams();
      params.set("adminId", adminId);
      if (q) params.set("q", q);
      if (date) params.set("date", date);

      try {
        const res = await fetch(`${API_BASE}/api/admin/bookings?${params.toString()}`);
        const data = await res.json();

        if (!Array.isArray(data)) {
          setStatus("danger", data.message || "Failed to load bookings.");
          return;
        }

        if (data.length === 0) {
          setStatus("warning", "No bookings found.");
          return;
        }

        setStatus("success", `Total bookings: ${data.length}`);

        data.forEach((b) => {
          const userName = b.user?.name || "-";
          const userEmail = b.user?.email || "-";
          const dateVal = b.date || "-";
          const timeVal = b.time || "-";
          const serviceVal = b.service || "-";

          const tr = document.createElement("tr");

          const delBtn = document.createElement("button");
          delBtn.className = "btn btn-sm btn-outline-danger";
          delBtn.type = "button";
          delBtn.innerText = "Delete";

          delBtn.addEventListener("click", () => {
            const info = `${userName} | ${userEmail} | ${dateVal} ${timeVal} | ${serviceVal}`;
            openDeleteModal(b._id, info);
          });

          tr.innerHTML = `
            <td>${userName}</td>
            <td>${userEmail}</td>
            <td>${dateVal}</td>
            <td>${timeVal}</td>
            <td>${serviceVal}</td>
            <td></td>
          `;

          tr.querySelector("td:last-child").appendChild(delBtn);
          tbody.appendChild(tr);
        });
      } catch (err) {
        setStatus("danger", "Failed to load. Make sure backend is running on port 3000.");
        console.log(err);
      }
    }

    loadAllBookings();
  </script>
</body>
</html>
